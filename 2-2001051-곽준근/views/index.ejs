<h2>ë§›ì§‘ ê²Œì‹œíŒ ëª©ë¡</h2>

<!-- ğŸ”¹ ì§€ë„ ì˜ì—­ -->
<div id="map" style="width:100%; height:300px; margin-bottom:20px; border:1px solid #ddd;"></div>

<!-- ğŸ”¹ ê²€ìƒ‰ í¼ -->
<form method="get" class="mb-3">
  <input type="hidden" name="sort" value="<%= typeof sort!=='undefined' ? sort : 'date' %>">
  <input type="hidden" name="order" value="<%= typeof order!=='undefined' ? order : 'desc' %>">
  <div class="input-group">
    <input type="text" class="form-control" name="q" value="<%= query || '' %>" placeholder="ì œëª© ê²€ìƒ‰">
    <button class="btn btn-outline-secondary">ê²€ìƒ‰</button>
  </div>
</form>

<a href="/write" class="btn btn-primary mb-3">ê¸€ì“°ê¸°</a>

<!-- ğŸ”¹ ê²Œì‹œê¸€ ëª©ë¡ í…Œì´ë¸” -->
<table class="table table-bordered">
  <thead>
    <tr>
      <th>
        <a href="<%= '/?sort=title&order=' + ((sort==='title' && order==='asc') ? 'desc' : 'asc') + (query ? '&q=' + encodeURIComponent(query) : '') %>">
          ì œëª© <%= sort==='title' ? (order==='asc' ? 'â–²' : 'â–¼') : '' %>
        </a>
      </th>
      <th style="width:140px;">
        <a href="<%= '/?sort=rating&order=' + ((sort==='rating' && order==='asc') ? 'desc' : 'asc') + (query ? '&q=' + encodeURIComponent(query) : '') %>">
          í‰ì  <%= sort==='rating' ? (order==='asc' ? 'â–²' : 'â–¼') : '' %>
        </a>
      </th>
      <th style="width:140px;">ì‘ì„±ì</th>
      <th style="width:200px;">
        <a href="<%= '/?sort=date&order=' + ((sort==='date' && order==='asc') ? 'desc' : 'asc') + (query ? '&q=' + encodeURIComponent(query) : '') %>">
          ì‘ì„±ì¼ <%= sort==='date' ? (order==='asc' ? 'â–²' : 'â–¼') : '' %>
        </a>
      </th>
    </tr>
  </thead>

  <tbody>
    <% posts.forEach(post => { %>
      <tr>
        <td><a href="/post/<%= post.id %>"><%= post.title %></a></td>
        <td><%= 'â˜…'.repeat(post.rating || 0) %><%= 'â˜†'.repeat(5 - (post.rating || 0)) %></td>
        <td><%= post.username %></td>
        <td><%= post.createdAt %></td>
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- ğŸ”¹ ì¹´ì¹´ì˜¤ ì§€ë„ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  (function () {
    var mapContainer = document.getElementById('map');
    if (!mapContainer) return;

    // ì¹´ì¹´ì˜¤ SDK ë¡œë“œ í™•ì¸
    if (!(window.kakao && kakao.maps)) {
      console.error('ì¹´ì¹´ì˜¤ ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨');
      mapContainer.innerHTML = 'ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      return;
    }

    // ê¸°ë³¸ ì§€ë„ ì˜µì…˜ (ì´ˆê¸° ì¤‘ì‹¬: ì„œìš¸)
    var mapOption = {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 5
    };

    var map = new kakao.maps.Map(mapContainer, mapOption);

    // ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ ê²Œì‹œê¸€ë“¤ ì¤‘ ìœ„ì¹˜(lat,lng) ìˆëŠ” ê²ƒë§Œ ë§ˆì»¤ë¡œ í‘œì‹œ
    var positions = <%- JSON.stringify(
      posts
        .filter(function (post) {
          return post.lat != null && post.lng != null;
        })
        .map(function (post) {
          return {
            title: post.title,
            lat: post.lat,
            lng: post.lng,
            url: '/post/' + post.id
          };
        })
    ) %>;

    // ë§ˆì»¤ + ì¸í¬ìœˆë„ìš° ìƒì„±
    positions.forEach(function (pos) {
      var marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(pos.lat, pos.lng),
        map: map
      });

      var iwContent =
        '<div style="padding:5px;font-size:12px;">'
        + pos.title
        + '<br><a href="' + pos.url + '">ìƒì„¸ë³´ê¸°</a></div>';

      var infowindow = new kakao.maps.InfoWindow({
        content: iwContent
      });

      kakao.maps.event.addListener(marker, 'click', function () {
        infowindow.open(map, marker);
      });
    });

    // ë§ˆì»¤ê°€ ì—¬ëŸ¬ ê°œë©´, ë²”ìœ„ì— ë§ê²Œ ì§€ë„ ì˜ì—­ ìë™ ì¡°ì •
    if (positions.length > 0) {
      var bounds = new kakao.maps.LatLngBounds();
      positions.forEach(function (pos) {
        bounds.extend(new kakao.maps.LatLng(pos.lat, pos.lng));
      });
      map.setBounds(bounds);
    }
  })();
</script>
